---
title: "autoQC report"
author: "SIgN_GM"
output: html_document
---


```{r setup, include=FALSE}
#knitr::opts_chunk$set(cache=FALSE)
opts_chunk$set(fig.align='center', out.width='750px', dpi=200)  #out.width='750px', dpi=200
#opts_chunk$set(dev = 'pdf')
```

## Quality control report 

> Input file name: `r filename`    
> Number of events: `r as.integer(dim(set[[i]])[1])`  
> The anomalies were removed from:  `r analysis`   
> Anomalies detected in total: **`r totalBadPerc * 100`** %  


### Number of events in each FCS file:

If the number of FCS files is higher than 3, a histogram reports the number of
events for each FCS file of the dataset. In blue is highlighted the FCS file 
whose quality control analysis is described in this report.


```{r, echo=FALSE, fig.height = 3}
if(length(set) >= 3 ){
  flow_set_plot(N_cell_set, area)
}
```


### Flow rate check

> **`r FlowRateQC$res_fr_QC$badPerc * 100`** % anomalies detected in the flow rate check.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width= 10}
  if (length(nchar(timeCh)) != 0 && !is.null(timeCh) && is.null(temptime)) {   
        flow_rate_plot(FlowRateQC) 
} 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
  if (length(nchar(timeCh)) == 0 || is.null(timeCh)) {   
        cat("It was not possible to analyse the flow rate since the \"Time\" channel was missing. \n")
  }else if( !is.null(temptime) && temptime == "single_value"){
cat("It was not possible to analyse the flow rate since the \"Time\" channel contains a single value. \n")
   }
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
  if (length(nchar(timeCh)) == 0 || is.null(timeCh)) {   
    cat(paste0("The plot reconstructs the flow rate with a resolution of 1/", 1/second_fractionFR, " of a second. Anomalies in the flow rate are identified with an algorithm based on the generalied ESD outlier detection method. The anomalies are circled in green. \n"))
   }
```

### Signals acquisition check

> **`r FlowSignalQC$Perc_bad_cells$badPerc_tot * 100`** % anomalies detected in the signal aquisition check. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
  if (outlierFS) { 
        cat(paste0("Outliers were removed before the changepoint analysis.", FlowSignalQC$Perc_bad_cells$badPerc_out * 100, "% of anomalies were detected as outliers and ", FlowSignalQC$Perc_bad_cells$badPerc_cp *100, " of anomalies were detected in the changepoint analysis. \n"))
   }
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height = h_FS_graph}
flow_signal_plot(FlowSignalQC)
```

The more stable region selected consistent for all channels is highlighted in yellow. If the removal of outliers has been required before the execution of the changepoint analysis, then the detected outliers are cicled in green.

The FCS file was divided in `r FlowSignalData$bins` bins. The stable region is located between the bins `r FlowSignalQC$segm[1]` and `r FlowSignalQC$segm[2]`.

##### More info on the changepoints detected:

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
if(!is.null(FlowSignalQC$tab_cpt)){
     cat("Changepoints detected in channels with shifts in signal acquisition:  \n")
}else{
  cat("No changepoints were detected.  \n")
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 4}
if(!is.null(FlowSignalQC$tab_cpt)){
   as.data.frame(FlowSignalQC$tab_cpt )
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
if(!is.null(ChRemoveFS)){
     cat(paste0("Channels excluded from the analysis: ", paste(ChannelRemovedFS, collapse = ", "), ". \n"))
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 4, results = 'asis'}
if(!is.null(FlowSignalQC$ch_no_cpt) && length(FlowSignalQC$ch_no_cpt) != 0 ){
  cat(paste0("No changepoints were detected in the channels: ", paste(FlowSignalQC$ch_no_cpt, collapse = ", "), ". \n"))
}
```

### Dynamic range check

> **`r FlowMarginQC$badPerc * 100`** % anomalies detected in dynamic range check.  

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width= 10}
flow_margin_plot(FlowMarginQC, FSbinSize)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results = 'asis'}
  if(length(FlowMarginQC$bad_lowerIDs) == 0 && length(FlowMarginQC$bad_upperIDs) == 0){
      cat("")
  }else{
    cat("The plot shows where the anomalies occured the most. The x-axis scale is complementary to the one of the signal acquisition plot. \n")
  }
```


##### More info on the margin events detected:

The table shows the number of events that did not pass the check for each channel:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
FlowMarginQC$margin_events
```
